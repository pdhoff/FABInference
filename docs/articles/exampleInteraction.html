<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FAB p-values for group-level slopes in ANCOVA models • FABInference</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="FAB p-values for group-level slopes in ANCOVA models">
<meta property="og:description" content="FABInference">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FABInference</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/exampleFHmodel.html">FAB p-values for small areas</a>
    </li>
    <li>
      <a href="../articles/exampleHMM.html">FAB p-values for a hidden Markov model</a>
    </li>
    <li>
      <a href="../articles/exampleInteraction.html">FAB p-values for group-level slopes in ANCOVA models</a>
    </li>
    <li>
      <a href="../articles/exampleLogistic.html">Asymptotically uniform FAB p-values</a>
    </li>
    <li>
      <a href="../articles/simstudy.html">Demo and simulation study of FAB p-values</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="exampleInteraction_files/header-attrs-2.5/header-attrs.js"></script><script src="exampleInteraction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="exampleInteraction_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="exampleInteraction_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>FAB p-values for group-level slopes in ANCOVA models</h1>
                        <h4 class="author">Peter Hoff</h4>
            
            <h4 class="date">2019-07-23</h4>
      
      
      <div class="hidden name"><code>exampleInteraction.Rmd</code></div>

    </div>

    
    
<hr>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
<p>Adaptive FAB <span class="math inline">\(p\)</span>-values are constructed for evaluating significance of a slope parameter for each level of a categorical variable. Specifically, we evaluate the significance of the relationship between student-level scores on a standardized exam and student-level SES scores for each school in the 2002 ELS study. Information is shared across schools using an exchangeable (i.i.d.) linking model for the school-level effects. This document serves as the replication code for the example in Section 4.2 of the article <a href="https://arxiv.org/abs/1907.12589">“Smaller <span class="math inline">\(p\)</span>-values via indirect information”</a> (Hoff 2019).</p>
</div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>The data for this example are from the 2002 Educational Longitudinal Survey, data from which can be obained at <a href="https://nces.ed.gov/surveys/els2002/" class="uri">https://nces.ed.gov/surveys/els2002/</a>. A subset of the data needed to replicate the example is available on my website and can be loaded using the following command:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span><span class="st">"http://www2.stat.duke.edu/~pdh10/Datasets/els.RData"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now take a look at all the variables:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">els</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span></code></pre></div>
<pre><code>##    school  flp urbanicity sctrl enrollment region female   ses nateng pared
## 1    1011 40.5          1     1          6      1      1 -0.23      1     5
## 2    1011 40.5          1     1          6      1      1  0.69      0     5
## 3    1011 40.5          1     1          6      1      1 -0.68      1     2
## 4    1011 40.5          1     1          6      1      1 -0.89      1     2
## 5    1011 40.5          1     1          6      1      1 -1.28      0     1
## 6    1011 40.5          1     1          6      1      0 -0.93      0     2
## 7    1011 40.5          1     1          6      1      0  0.36      1     6
## 8    1011 40.5          1     1          6      1      0 -0.24      1     2
## 9    1011 40.5          1     1          6      1      0 -0.85      1     2
## 10   1011 40.5          1     1          6      1      0 -1.07      1     1
##    mscore rscore cscore rural suburban urban public catholic private rn rm rs
## 1   52.11  59.53  56.21     0        0     1      1        0       0  1  0  0
## 2   57.65  56.70  57.66     0        0     1      1        0       0  1  0  0
## 3   66.44  64.46  66.50     0        0     1      1        0       0  1  0  0
## 4   44.68  48.69  46.46     0        0     1      1        0       0  1  0  0
## 5   40.57  33.53  36.17     0        0     1      1        0       0  1  0  0
## 6   35.04  28.85  30.72     0        0     1      1        0       0  1  0  0
## 7   50.71  40.80  45.46     0        0     1      1        0       0  1  0  0
## 8   66.17  68.28  68.39     0        0     1      1        0       0  1  0  0
## 9   39.43  45.73  42.07     0        0     1      1        0       0  1  0  0
## 10  46.17  41.05  43.17     0        0     1      1        0       0  1  0  0
##    rw pcgrad
## 1   0      0
## 2   0      0
## 3   0      0
## 4   0      0
## 5   0      0
## 6   0      0
## 7   0      1
## 8   0      0
## 9   0      0
## 10  0      0</code></pre>
<p>First we do an overall <span class="math inline">\(F\)</span>-test to evaluate if there is heterogeneity in the relationship between <code>rscore</code> and <code>ses</code> after controlling for the other variables.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit1</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">rscore</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">school</span><span class="op">)</span> <span class="op">+</span> <span class="va">ses</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">school</span><span class="op">)</span><span class="op">*</span><span class="va">ses</span> <span class="op">+</span>
                 <span class="va">female</span> <span class="op">+</span> <span class="va">nateng</span> <span class="op">+</span> <span class="va">pcgrad</span>, data<span class="op">=</span><span class="va">els</span><span class="op">)</span>
<span class="va">fit0</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">rscore</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">school</span><span class="op">)</span> <span class="op">+</span> <span class="va">ses</span> <span class="op">+</span>  
                 <span class="va">female</span> <span class="op">+</span> <span class="va">nateng</span> <span class="op">+</span> <span class="va">pcgrad</span>, data<span class="op">=</span><span class="va">els</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">fit0</span>,<span class="va">fit1</span><span class="op">)</span></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Model 1: rscore ~ as.factor(school) + ses + female + nateng + pcgrad
## Model 2: rscore ~ as.factor(school) + ses + as.factor(school) * ses + 
##     female + nateng + pcgrad
##   Res.Df    RSS  Df Sum of Sq      F    Pr(&gt;F)    
## 1  13418 929333                                   
## 2  12735 871675 683     57658 1.2333 4.549e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<p>The <span class="math inline">\(p\)</span>-value is tiny, suggesting that schools do indeed vary in terms of the relationship between these two variables. Therefore, it is not appropriate to just test for an overall effect of SES on reading score and then use that to claim that the effect is present for each school separately.</p>
<p>Consider the linear regression model <span class="math display">\[
 Y_{i,j} =  \gamma_j + \alpha^\top w_{i,j} +  \beta_j x_{i,j} + \sigma \epsilon_{i,j} 
\]</span> where <span class="math inline">\(Y_{i,j}\)</span> is the reading score of the <span class="math inline">\(i\)</span>th student in school <span class="math inline">\(j\)</span> and <span class="math inline">\(x_{i,j}\)</span> is the SES score of that student. The standard <span class="math inline">\(p\)</span>-value for evaluating <span class="math inline">\(H_j:\beta_j=0\)</span> is obtained from the distribution of the OLS estimate of <span class="math inline">\(\beta_j\)</span>. Here, we obtain the OLS estimates and standard <span class="math inline">\(p\)</span>-values. Then with the linking model <span class="math inline">\(\beta_1,\ldots, \beta_p \sim\)</span> i.i.d. <span class="math inline">\(N(\mu,\tau^2)\)</span>, we construct FAB <span class="math inline">\(p\)</span>-values.</p>
<p>First we gather the variables:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span><span class="op">&lt;-</span><span class="va">els</span><span class="op">$</span><span class="va">rscore</span> 
<span class="va">g</span><span class="op">&lt;-</span><span class="va">els</span><span class="op">$</span><span class="va">school</span> 
<span class="va">x</span><span class="op">&lt;-</span><span class="va">els</span><span class="op">$</span><span class="va">ses</span>
<span class="va">W</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">els</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"female"</span>,<span class="st">"nateng"</span>,<span class="st">"pcgrad"</span><span class="op">)</span> <span class="op">]</span> <span class="op">)</span>   

<span class="va">ug</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span>
<span class="va">G</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ug</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">g</span>,<span class="va">ug</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">GX</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="va">G</span>,<span class="fl">1</span>,<span class="va">x</span>,<span class="st">"*"</span><span class="op">)</span></code></pre></div>
<ul>
<li>
<code>y</code> is an <span class="math inline">\(n\)</span>-vector of the outcome for each student;</li>
<li>
<code>G</code> is an <span class="math inline">\(n\times p\)</span> binary matrix indicating which of the <span class="math inline">\(p\)</span> schools each student is in;</li>
<li>
<code>W</code> is an <span class="math inline">\(n\times q\)</span> matrix of other student-level explanatory variables;</li>
<li>
<code>GX</code> is an <span class="math inline">\(n\times p\)</span> matrix obtained by multiplying each row of <span class="math inline">\(G\)</span> by the corresponding students SES score. This is the interaction variable.</li>
</ul>
<p>The basic strategy is as follows: * Obtain the OLS estimates for the <code>GX</code> variables in a linear regression model that includes <code>G</code>, <code>W</code> and <code>GX</code> as predictors. The OLS estimates are our direct data for each <span class="math inline">\(\beta_j, j=1,\ldots, p\)</span>. * For each <span class="math inline">\(\hat\beta_j\)</span>, obtain estimates of the mean <span class="math inline">\(\mu\)</span> and variance <span class="math inline">\(\tau^2\)</span> in the linking model <span class="math inline">\(\beta_1,\ldots, \beta_p \sim\)</span> i.i.d. <span class="math inline">\(N(\mu, \tau^2)\)</span>, using data that is uncorrelated with <span class="math inline">\(\hat\beta_j\)</span>.<br>
* Use the parameter estimates to construct the FAB <span class="math inline">\(p\)</span>-value for group <span class="math inline">\(j\)</span>.</p>
<p>I have written the following functions to do all this. Here is the main function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pFABreg</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">y</span>,<span class="va">X</span>,<span class="va">W</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>

  <span class="co">## FAB p-values for the regression coefficients associated with $X$ </span>
  <span class="co">## assuming an i.i.d. normal prior. The matrix W can include other </span>
  <span class="co">## regressors. </span>

  <span class="co">## Future work: Allow for information splitting for estimation </span>
  <span class="co">## of s2, the error variance. </span>

  <span class="va">p</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>

  <span class="va">XW</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">X</span>,<span class="va">W</span><span class="op">)</span>
  <span class="va">fit</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span> <span class="op">-</span><span class="fl">1</span><span class="op">+</span><span class="va">XW</span><span class="op">)</span>
  <span class="va">betaOLS</span><span class="op">&lt;-</span><span class="va">fit</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">]</span>
  <span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">XW</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">XW</span><span class="op">)</span>
  <span class="va">s2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">res</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">df</span>

  <span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">XW</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span>,<span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">]</span>
  <span class="va">v</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span>

  <span class="va">PSI</span><span class="op">&lt;-</span><span class="cn">NULL</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span><span class="op">{</span>
    <span class="va">G</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/Null.html">Null</a></span><span class="op">(</span><span class="va">V</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
    <span class="va">PSI</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">PSI</span>,<span class="fu">mmleEXG</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">%*%</span><span class="va">betaOLS</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">%*%</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">p</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">%*%</span><span class="va">V</span><span class="op">%*%</span><span class="va">G</span>  <span class="op">)</span> <span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">j</span><span class="op">%%</span><span class="fl">10</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">j</span><span class="op">/</span><span class="va">p</span>,<span class="st">"\n"</span><span class="op">)</span> <span class="op">}</span>
  <span class="op">}</span>

  <span class="va">TSTAT</span><span class="op">&lt;-</span><span class="va">betaOLS</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">v</span><span class="op">*</span><span class="va">s2</span><span class="op">)</span>

  <span class="va">pU</span><span class="op">&lt;-</span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">pt</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">TSTAT</span><span class="op">)</span>,<span class="va">df</span><span class="op">)</span>
  <span class="va">pF</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">pt</a></span><span class="op">(</span><span class="va">TSTAT</span><span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="va">PSI</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">v</span><span class="op">*</span><span class="va">PSI</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">PSI</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="va">df</span><span class="op">)</span>  <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">pt</a></span><span class="op">(</span><span class="op">-</span><span class="va">TSTAT</span>,<span class="va">df</span><span class="op">)</span> <span class="op">)</span>
  <span class="va">RES</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">betaOLS</span>,<span class="va">v</span>,<span class="va">s2</span>,<span class="va">TSTAT</span>,<span class="va">df</span>,<span class="va">PSI</span>,<span class="va">pU</span>,<span class="va">pF</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">RES</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"betaOLS"</span>,<span class="st">"v unscaled"</span>,<span class="st">"s2res"</span>,<span class="st">"t-stat"</span>,<span class="st">"df"</span>,<span class="st">"mu"</span>,<span class="st">"t2"</span>,<span class="st">"s2mlik"</span>,<span class="st">"pU"</span>,<span class="st">"pF"</span><span class="op">)</span>
  <span class="va">RES</span>
<span class="op">}</span></code></pre></div>
<p>Here is a helper function that computes the MMLE of the parameters in the linking model:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mmleEXG</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">y</span>,<span class="va">x</span>,<span class="va">V</span><span class="op">)</span><span class="op">{</span>

  <span class="co">## mml estimation under the model </span>
  <span class="co">## $y \sim N(\theta,V \sigma^2)$ </span>
  <span class="co">## $\theta \sim N( x \mu,\tau^2 I)$</span>
  <span class="co">## where $V$ is known </span>

  <span class="va">eV</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span>
  <span class="va">E</span><span class="op">&lt;-</span><span class="va">eV</span><span class="op">$</span><span class="va">vec</span>
  <span class="va">L</span><span class="op">&lt;-</span><span class="va">eV</span><span class="op">$</span><span class="va">val</span>

  <span class="va">obj</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">lt2s2</span><span class="op">)</span><span class="op">{</span>
    <span class="va">t2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">lt2s2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
    <span class="va">s2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">lt2s2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
    <span class="va">G</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">t2</span><span class="op">+</span><span class="va">L</span><span class="op">*</span><span class="va">s2</span><span class="op">)</span>

    <span class="va">iVy</span><span class="op">&lt;-</span><span class="va">E</span><span class="op">%*%</span><span class="op">(</span> <span class="va">G</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span><span class="op">%*%</span><span class="va">y</span><span class="op">)</span> <span class="op">)</span>
    <span class="va">iVx</span><span class="op">&lt;-</span><span class="va">E</span><span class="op">%*%</span><span class="op">(</span> <span class="va">G</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span><span class="op">%*%</span><span class="va">x</span><span class="op">)</span> <span class="op">)</span>

    <span class="va">RSS</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">iVy</span><span class="op">*</span><span class="va">y</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">iVx</span><span class="op">*</span><span class="va">y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">iVx</span><span class="op">*</span><span class="va">x</span><span class="op">)</span>
    <span class="va">ldet</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span>

    <span class="va">RSS</span> <span class="op">-</span> <span class="va">ldet</span>
  <span class="op">}</span>

  <span class="va">t2s2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="va">obj</span><span class="op">)</span><span class="op">$</span><span class="va">par</span><span class="op">)</span> ; <span class="va">t2</span><span class="op">&lt;-</span><span class="va">t2s2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> ; <span class="va">s2</span><span class="op">&lt;-</span><span class="va">t2s2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  <span class="va">G</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">t2</span><span class="op">+</span><span class="va">L</span><span class="op">*</span><span class="va">s2</span><span class="op">)</span>
  <span class="va">iVy</span><span class="op">&lt;-</span><span class="va">E</span><span class="op">%*%</span><span class="op">(</span> <span class="va">G</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span><span class="op">%*%</span><span class="va">y</span><span class="op">)</span> <span class="op">)</span>
  <span class="va">iVx</span><span class="op">&lt;-</span><span class="va">E</span><span class="op">%*%</span><span class="op">(</span> <span class="va">G</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span><span class="op">%*%</span><span class="va">x</span><span class="op">)</span> <span class="op">)</span>
  <span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">iVx</span><span class="op">*</span><span class="va">y</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">iVx</span><span class="op">*</span><span class="va">x</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mu</span>,<span class="va">t2</span>,<span class="va">s2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Ok, now we compute all the FAB <span class="math inline">\(p\)</span>-values. This will take a while.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pVALS</span><span class="op">&lt;-</span><span class="fu">pFABreg</span><span class="op">(</span><span class="va">y</span>,<span class="va">GX</span>,<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">G</span>,<span class="va">W</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 0.01461988 
## 0.02923977 
## 0.04385965 
## 0.05847953 
## 0.07309942 
## 0.0877193 
## 0.1023392 
## 0.1169591 
## 0.1315789 
## 0.1461988 
## 0.1608187 
## 0.1754386 
## 0.1900585 
## 0.2046784 
## 0.2192982 
## 0.2339181 
## 0.248538 
## 0.2631579 
## 0.2777778 
## 0.2923977 
## 0.3070175 
## 0.3216374 
## 0.3362573 
## 0.3508772 
## 0.3654971 
## 0.380117 
## 0.3947368 
## 0.4093567 
## 0.4239766 
## 0.4385965 
## 0.4532164 
## 0.4678363 
## 0.4824561 
## 0.497076 
## 0.5116959 
## 0.5263158 
## 0.5409357 
## 0.5555556 
## 0.5701754 
## 0.5847953 
## 0.5994152 
## 0.6140351 
## 0.628655 
## 0.6432749 
## 0.6578947 
## 0.6725146 
## 0.6871345 
## 0.7017544 
## 0.7163743 
## 0.7309942 
## 0.745614 
## 0.7602339 
## 0.7748538 
## 0.7894737 
## 0.8040936 
## 0.8187135 
## 0.8333333 
## 0.8479532 
## 0.8625731 
## 0.877193 
## 0.8918129 
## 0.9064327 
## 0.9210526 
## 0.9356725 
## 0.9502924 
## 0.9649123 
## 0.9795322 
## 0.994152</code></pre>
<p>Save some results:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resultsInteraction</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> BOLS<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"betaOLS"</span><span class="op">]</span>,  
                 N<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span>, 
                 VUNS<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"v unscaled"</span><span class="op">]</span>, 
                 S2U<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"s2res"</span><span class="op">]</span>, 
                 T<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"t-stat"</span><span class="op">]</span>,
                 DF<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"df"</span><span class="op">]</span>,  
                 pU<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"pU"</span><span class="op">]</span>, 
                 ETHETA<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"mu"</span><span class="op">]</span>,
                 TAU<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"t2"</span><span class="op">]</span><span class="op">)</span>, 
                 SIGMA<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"s2mlik"</span><span class="op">]</span><span class="op">)</span>, 
                 pF<span class="op">=</span><span class="va">pVALS</span><span class="op">[</span>,<span class="st">"pF"</span><span class="op">]</span><span class="op">)</span>  

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">resultsInteraction</span>,file<span class="op">=</span><span class="st">"resultsInteraction.RData"</span><span class="op">)</span></code></pre></div>
<p>Summary of some results:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>,mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.75</span>,<span class="fl">.75</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">resultsInteraction</span><span class="op">$</span><span class="va">VUNS</span><span class="op">*</span><span class="va">resultsInteraction</span><span class="op">$</span><span class="va">S2U</span><span class="op">)</span><span class="op">)</span>,  <span class="va">resultsInteraction</span><span class="op">$</span><span class="va">BOLS</span>,
    xlab<span class="op">=</span><span class="st">"1/(direct estimate standard error)"</span>, ylab<span class="op">=</span><span class="st">"direct estimate"</span>  <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">resultsInteraction</span><span class="op">$</span><span class="va">ETHETA</span><span class="op">)</span><span class="op">)</span>
<span class="va">ise</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.05</span>,<span class="fl">.65</span>,length<span class="op">=</span><span class="fl">100</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span> <span class="va">ise</span>,<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">resultsInteraction</span><span class="op">$</span><span class="va">BOLS</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.975</span><span class="op">)</span><span class="op">/</span><span class="va">ise</span>,col<span class="op">=</span><span class="st">"gray"</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span> <span class="va">ise</span>,<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">resultsInteraction</span><span class="op">$</span><span class="va">BOLS</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.975</span><span class="op">)</span><span class="op">/</span><span class="va">ise</span>,col<span class="op">=</span><span class="st">"gray"</span> <span class="op">)</span>

<span class="va">pU</span><span class="op">&lt;-</span><span class="va">resultsInteraction</span><span class="op">$</span><span class="va">pU</span>
<span class="va">pF</span><span class="op">&lt;-</span><span class="va">resultsInteraction</span><span class="op">$</span><span class="va">pF</span>

<span class="va">sigU</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pU</span><span class="op">&lt;</span><span class="fl">.05</span><span class="op">)</span>
<span class="va">sigF</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pF</span><span class="op">&lt;</span><span class="fl">.05</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pU</span>,<span class="va">pF</span>,xlab<span class="op">=</span><span class="st">"UMPU p-value"</span>,ylab<span class="op">=</span><span class="st">"FAB p-value"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">pU</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"l"</span>,xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">350</span><span class="op">)</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">.06</span><span class="op">)</span>,lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="st">"pink"</span>,
          xlab<span class="op">=</span><span class="st">"rank"</span>,ylab<span class="op">=</span><span class="st">"p-value"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">pF</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"lightblue"</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">.05</span>,col<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">.045</span>,lwd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pink"</span>,<span class="st">"lightblue"</span><span class="op">)</span>,legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"UMPU"</span>,<span class="st">"FAB"</span><span class="op">)</span>,
       bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></code></pre></div>
<p><img src="exampleInteraction_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Peter Hoff.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
